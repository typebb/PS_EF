SET ANSI_NULLS ON
GO

SET QUOTED_IDENTIFIER ON
GO

CREATE DATABASE Bestellingssysteem
GO

USE [Bestellingssysteem]
GO

CREATE TABLE [dbo].[PRODUCT](
	[PRODUCT_ID] [bigint] IDENTITY(1,1) NOT NULL,
	[NAME] [nvarchar](1024) NOT NULL,
	[PRICE] [decimal](18, 2) NOT NULL,
	[VALID] [int] NOT NULL DEFAULT 1,
	-- COLUMNS THAT ARE AUTOMATICALLY MAINTAINED; AUDIT TRAIL:
	[AUTO_TIME_CREATION] [datetime2](7) NOT NULL,
	[AUTO_UPDATE_COUNT] bigint NOT NULL DEFAULT 0,
	[AUTO_TIME_UPDATE] [datetime2](7) NOT NULL,
	[AUTO_UPDATED_BY] [nvarchar](max) NOT NULL,
 CONSTRAINT [PK_PRODUCT] PRIMARY KEY CLUSTERED ([PRODUCT_ID] ASC)
)
GO

ALTER TABLE [dbo].[PRODUCT] ADD  CONSTRAINT [DF_PRODUCT_AUTO_TIME_CREATION]  DEFAULT (sysdatetime()) FOR [AUTO_TIME_CREATION]
GO
ALTER TABLE [dbo].[PRODUCT] ADD  CONSTRAINT [DF_PRODUCT_AUTO_TIME_UPDATE]  DEFAULT (sysdatetime()) FOR [AUTO_TIME_UPDATE]
GO
ALTER TABLE [dbo].[PRODUCT] ADD  CONSTRAINT [DF_PRODUCT_AUTO_UPDATED_BY]  DEFAULT (suser_sname()) FOR [AUTO_UPDATED_BY]
GO
CREATE TRIGGER UPDATE_PRODUCT_TR
ON PRODUCT
FOR UPDATE AS
UPDATE PRODUCT
SET AUTO_UPDATE_COUNT = AUTO_UPDATE_COUNT + 1,
AUTO_TIME_UPDATE = SYSDATETIME(),
AUTO_UPDATED_BY = suser_sname()
WHERE PRODUCT_ID = ( SELECT PRODUCT_ID FROM DELETED )
GO

CREATE TABLE [dbo].[CUSTOMER](
	[CUSTOMER_ID] [bigint] IDENTITY(1,1) NOT NULL,
	[NAME] [nvarchar](512) NOT NULL,
	-- potentially gigabytes, but only takes actual space because of varchar:
	[ADDRESS] [nvarchar](max) NOT NULL,
	[AUTO_VALID] [int] NOT NULL DEFAULT 1,
	[AUTO_TIME_CREATION] [datetime2](7) NOT NULL,
	[AUTO_UPDATE_COUNT] bigint NOT NULL DEFAULT 0,
	[AUTO_TIME_UPDATE] [datetime2](7) NOT NULL,
	[AUTO_UPDATED_BY] [nvarchar](max) NOT NULL,
 CONSTRAINT [PK_CUSTOMER] PRIMARY KEY CLUSTERED ([CUSTOMER_ID] ASC)
)
GO

ALTER TABLE [dbo].[CUSTOMER] ADD  CONSTRAINT [DF_CUSTOMER_AUTO_TIME_CREATION]  DEFAULT (sysdatetime()) FOR [AUTO_TIME_CREATION]
GO
ALTER TABLE [dbo].[CUSTOMER] ADD  CONSTRAINT [DF_CUSTOMER_AUTO_TIME_UPDATE]  DEFAULT (sysdatetime()) FOR [AUTO_TIME_UPDATE]
GO
ALTER TABLE [dbo].[CUSTOMER] ADD  CONSTRAINT [DF_CUSTOMER_AUTO_UPDATED_BY]  DEFAULT (suser_sname()) FOR [AUTO_UPDATED_BY]
GO
CREATE TRIGGER UPDATE_CUSTOMER_TR
ON CUSTOMER
FOR UPDATE AS
UPDATE CUSTOMER
SET AUTO_UPDATE_COUNT = AUTO_UPDATE_COUNT + 1,
AUTO_TIME_UPDATE = SYSDATETIME(),
AUTO_UPDATED_BY = suser_sname()
WHERE CUSTOMER_ID = ( SELECT CUSTOMER_ID FROM DELETED )
GO

CREATE TABLE [dbo].[ORDER](
	[ORDER_ID] [bigint] IDENTITY(1,1) NOT NULL,
	[PAID] [int] NOT NULL,
	[PRICE] [decimal](18, 2) NULL,
	[CUSTOMER_ID] [bigint] NOT NULL,
	[TIME] [datetime2](7) NULL,
	[AUTO_VALID] [int] NOT NULL DEFAULT 1,
	[AUTO_TIME_CREATION] [datetime2](7) NOT NULL,
	[AUTO_UPDATE_COUNT] bigint NOT NULL DEFAULT 0,
	[AUTO_TIME_UPDATE] [datetime2](7) NOT NULL,
	[AUTO_UPDATED_BY] [nvarchar](max) NOT NULL,
 CONSTRAINT [PK_ORDER] PRIMARY KEY CLUSTERED ([ORDER_ID] ASC),
 CONSTRAINT [FK_ORDER_CUSTOMER] FOREIGN KEY (CUSTOMER_ID) REFERENCES [dbo].[CUSTOMER] (CUSTOMER_ID)
 ON DELETE CASCADE
 ON UPDATE CASCADE
)
GO

ALTER TABLE [dbo].[ORDER] ADD  CONSTRAINT [DF_ORDER_AUTO_TIME_CREATION]  DEFAULT (sysdatetime()) FOR [AUTO_TIME_CREATION]
GO
ALTER TABLE [dbo].[ORDER] ADD  CONSTRAINT [DF_ORDER_AUTO_TIME_UPDATE]  DEFAULT (sysdatetime()) FOR [AUTO_TIME_UPDATE]
GO
ALTER TABLE [dbo].[ORDER] ADD  CONSTRAINT [DF_ORDER_AUTO_UPDATED_BY]  DEFAULT (suser_sname()) FOR [AUTO_UPDATED_BY]
GO
CREATE TRIGGER UPDATE_ORDER_TR
ON [dbo].[ORDER]
FOR UPDATE AS
UPDATE [dbo].[ORDER]
SET AUTO_UPDATE_COUNT = AUTO_UPDATE_COUNT + 1,
AUTO_TIME_UPDATE = SYSDATETIME(),
AUTO_UPDATED_BY = suser_sname()
WHERE ORDER_ID = ( SELECT ORDER_ID FROM DELETED )
GO

CREATE TABLE [dbo].[ORDER_PRODUCT](
	[ID] [bigint] NULL,
	[ORDER_ID] [bigint] NOT NULL,
	[PRODUCT_ID] [bigint] NOT NULL,
	[AMOUNT] [int] NOT NULL DEFAULT(0),
 CONSTRAINT [PK_ORDER_PRODUCT] PRIMARY KEY CLUSTERED ([ORDER_ID] ASC,[PRODUCT_ID] ASC),
 CONSTRAINT [FK_ORDER_PRODUCT_ORDER] FOREIGN KEY (ORDER_ID) REFERENCES [dbo].[ORDER] (ORDER_ID)
 ON DELETE CASCADE
 ON UPDATE CASCADE,
 CONSTRAINT [FK_ORDER_PRODUCT_PRODUCT] FOREIGN KEY (PRODUCT_ID) REFERENCES [dbo].[PRODUCT] (PRODUCT_ID)
 ON DELETE CASCADE
 ON UPDATE CASCADE
)
GO

-- Example of an index to speed up search; CLUSTERED to prevent problems inserting

/*
All versions
If you create an index on a column that its definition is longer than 900 or 1700 (depending on version and type of index), you'll either get a warning and the index creation will succeed (if the table is empty or the existing data are not that long) or an error and the index creation will fail (if a row or more exceed the limit).

A primary key is automatically indexed!
*/

CREATE NONCLUSTERED INDEX IX_CUSTOMER_NAME ON CUSTOMER(NAME)
GO